<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro Cam v2 - High Contrast</title>
    <style>
        body { background: #000; color: #eee; font-family: -apple-system, sans-serif; margin: 0; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        
        /* 覆盖层：初始权限请求 */
        #permissionOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center; padding: 20px;
        }

        canvas { display: block; width: 100vw; height: 100vh; object-fit: cover; }
        
        .ui-overlay { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(15px);
            padding: 15px; border-top: 1px solid #333;
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .control-group { text-align: left; }
        label { font-size: 9px; color: #888; display: block; margin-bottom: 4px; text-transform: uppercase; font-weight: bold; }
        
        input[type="range"] { width: 100%; accent-color: #ff4500; height: 20px; margin: 0; }
        input[type="color"] { background: none; border: 1px solid #444; width: 100%; height: 25px; border-radius: 4px; }

        .btn-main { 
            background: #fff; color: #000; border: none; padding: 15px 30px;
            font-weight: bold; border-radius: 30px; font-size: 14px; cursor: pointer;
        }

        .btn-capture { 
            grid-column: span 2; background: #ff4500; color: #fff; border: none; 
            padding: 12px; font-weight: bold; border-radius: 8px; font-size: 13px; margin-top: 5px;
        }
        
        video { display: none; }
        .error-msg { color: #ff4444; font-size: 12px; margin-top: 20px; max-width: 80%; }
    </style>
</head>
<body>

<div id="permissionOverlay">
    <h2 style="margin-bottom: 10px;">Retro High-Contrast Cam</h2>
    <p style="color: #666; font-size: 13px; margin-bottom: 30px;">需要摄像头权限以实现实时滤镜效果<br>(请确保处于 HTTPS 环境)</p>
    <button class="btn-main" onclick="startCamera()">开启摄像头 / START CAMERA</button>
    <div id="errorLog" class="error-msg"></div>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<div class="ui-overlay">
    <div class="control-group">
        <label>Light Color</label>
        <input type="color" id="fgColor" value="#ffce00">
    </div>
    <div class="control-group">
        <label>Dark Color</label>
        <input type="color" id="bgColor" value="#000000">
    </div>

    <div class="control-group">
        <label>Face Detail (HE)</label>
        <input type="range" id="eqAmount" min="0" max="100" value="75">
    </div>

    <div class="control-group">
        <label>Exposure</label>
        <input type="range" id="threshold" min="0" max="255" value="128">
    </div>

    <div class="control-group" style="grid-column: span 2;">
        <label>Film Grain</label>
        <input type="range" id="noiseAmt" min="0" max="150" value="45">
    </div>

    <button id="captureBtn" class="btn-capture">SAVE PHOTO TO ALBUM</button>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const errorLog = document.getElementById('errorLog');
    const overlay = document.getElementById('permissionOverlay');
    
    async function startCamera() {
        errorLog.innerText = "请求中...";
        
        const constraints = {
            video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
            audio: false
        };

        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                overlay.style.display = 'none'; // 成功后隐藏遮罩
                video.play();
                requestAnimationFrame(processFrame);
            };
        } catch (err) {
            console.error(err);
            let msg = "访问失败: ";
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                msg += "必须使用 HTTPS 安全链接才能调用摄像头。";
            } else if (err.name === 'NotAllowedError') {
                msg += "您拒绝了摄像头访问权限，请在浏览器设置中开启。";
            } else {
                msg += err.message;
            }
            errorLog.innerText = msg;
        }
    }

    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return { r, g, b };
    }

    function getEqualizedLut(pixels) {
        let hist = new Int32Array(256);
        for (let i = 0; i < pixels.length; i += 4) {
            hist[pixels[i]]++; 
        }
        let cdf = new Int32Array(256);
        cdf[0] = hist[0];
        for (let i = 1; i < 256; i++) cdf[i] = cdf[i - 1] + hist[i];
        
        const minCdf = cdf.find(x => x > 0);
        const total = pixels.length / 4;
        let lut = new Uint8Array(256);
        for (let i = 0; i < 256; i++) {
            lut[i] = ((cdf[i] - minCdf) / (total - minCdf)) * 255;
        }
        return lut;
    }

    function processFrame() {
        if (video.paused || video.ended) return;

        if (canvas.width !== window.innerWidth) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        const vW = video.videoWidth;
        const vH = video.videoHeight;
        const cW = canvas.width;
        const cH = canvas.height;

        // 居中裁剪绘制
        const vRatio = vW / vH;
        const cRatio = cW / cH;
        let sx, sy, sw, sh;

        if (vRatio > cRatio) {
            sw = vH * cRatio; sh = vH;
            sx = (vW - sw) / 2; sy = 0;
        } else {
            sw = vW; sh = vW / cRatio;
            sx = 0; sy = (vH - sh) / 2;
        }

        ctx.filter = 'grayscale(1)';
        ctx.drawImage(video, sx, sy, sw, sh, 0, 0, cW, cH);
        
        const imgData = ctx.getImageData(0, 0, cW, cH);
        const pixels = imgData.data;
        
        const threshold = parseInt(document.getElementById('threshold').value);
        const noiseAmt = parseInt(document.getElementById('noiseAmt').value);
        const eqAmount = parseInt(document.getElementById('eqAmount').value) / 100;
        const fg = hexToRgb(document.getElementById('fgColor').value);
        const bg = hexToRgb(document.getElementById('bgColor').value);
        
        const lut = getEqualizedLut(pixels);

        for (let i = 0; i < pixels.length; i += 4) {
            const gray = pixels[i];
            const val = gray * (1 - eqAmount) + lut[gray] * eqAmount;
            const isBright = (val + (Math.random() - 0.5) * noiseAmt) > threshold;
            
            pixels[i]     = isBright ? fg.r : bg.r;
            pixels[i + 1] = isBright ? fg.g : bg.g;
            pixels[i + 2] = isBright ? fg.b : bg.b;
        }

        ctx.filter = 'none';
        ctx.putImageData(imgData, 0, 0);
        requestAnimationFrame(processFrame);
    }

    document.getElementById('captureBtn').onclick = () => {
        const dataUrl = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `retro_snap_${Date.now()}.png`;
        link.href = dataUrl;
        link.click();
    };
</script>

</body>
</html>